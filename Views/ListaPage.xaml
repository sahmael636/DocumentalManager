<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="DocumentalManager.Views.ListaPage"
             xmlns:viewmodels="clr-namespace:DocumentalManager.ViewModels"
             xmlns:models="clr-namespace:DocumentalManager.Models"
             x:Name="RootPage"
             x:DataType="viewmodels:ListaViewModel"
             Title="{Binding TableName}">

    <Grid RowDefinitions="Auto, Auto, *">

        <!-- Toolbar -->
        <HorizontalStackLayout Grid.Row="0" 
                               Padding="10" 
                               Spacing="10"
                               BackgroundColor="#F5F5F5">

            <Button Text="Nuevo"
                    Command="{Binding NuevoCommand}"
                    BackgroundColor="#4CAF50"
                    TextColor="White"
                    HeightRequest="40"
                    CornerRadius="5"/>

            <Button Text="Importar"
                    Command="{Binding ImportarCommand}"
                    BackgroundColor="#FF9800"
                    TextColor="White"
                    HeightRequest="40"
                    CornerRadius="5"/>

            <Button Text="Exportar"
                    Command="{Binding ExportarCommand}"
                    BackgroundColor="#2196F3"
                    TextColor="White"
                    HeightRequest="40"
                    CornerRadius="5"/>

        </HorizontalStackLayout>

        <!-- Search Bar -->
        <Border Grid.Row="1" 
                Padding="10"
                StrokeThickness="1"
                Stroke="#DDDDDD">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="8"/>
            </Border.StrokeShape>

            <Grid ColumnDefinitions="*, Auto">
                <Entry Grid.Column="0"
                       Placeholder="Buscar..."
                       Text="{Binding SearchText}"
                       TextChanged="OnSearchTextChanged"
                       HeightRequest="40"/>

                <Button Grid.Column="1"
                        Text="Buscar"
                        Command="{Binding FilterItemsCommand}"
                        BackgroundColor="#2196F3"
                        TextColor="White"
                        WidthRequest="80"
                        Margin="5,0,0,0"
                        HeightRequest="40"/>
            </Grid>
        </Border>

        <!-- List -->
        <CollectionView Grid.Row="2"
                        ItemsSource="{Binding FilteredItems}"
                        SelectionMode="None"
                        Margin="0,10,0,0">

            <CollectionView.ItemTemplate>
                <!-- x:DataType apunta a la clase base que contiene Codigo/Nombre/Observacion -->
                <DataTemplate x:DataType="models:BaseEntity">
                    <Border Padding="10"
                            Margin="0,0,0,5"
                            StrokeThickness="1"
                            Stroke="#DDDDDD">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="5"/>
                        </Border.StrokeShape>

                        <Grid ColumnDefinitions="*, Auto,Auto">

                            <VerticalStackLayout Grid.Column="0" Spacing="5">
                                <Label Text="{Binding Codigo}" 
                                       FontAttributes="Bold"
                                       TextColor="#2b0b98"/>
                                <Label Text="{Binding Nombre}"/>
                                <Label Text="{Binding Observacion}" 
                                       TextColor="#666666"
                                       FontSize="12"
                                       IsVisible="{Binding Observacion, Converter={StaticResource IsNotNullOrEmptyConverter}}"/>
                            </VerticalStackLayout>

                            <Button Grid.Column="1"
                                    Text="✏️"
                                    Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.EditarCommand}"
                                    CommandParameter="{Binding .}"
                                    BackgroundColor="#FFC107"
                                    TextColor="White"
                                    WidthRequest="40"
                                    Margin="5"/>

                            <Button Grid.Column="2"
                                    Text="🗑️"
                                    Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.EliminarCommand}"
                                    CommandParameter="{Binding .}"
                                    BackgroundColor="#F44336"
                                    TextColor="White"
                                    WidthRequest="40"
                                    Margin="5"/>

                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>