// ==================================================
// Nombre del archivo: C:\Users\asbee\source\repos\sahmael636\DocumentalManager\ViewModels\FormularioViewModel.cs
// ==================================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using DocumentalManager.Models;
using DocumentalManager.Services;
using System.Collections.ObjectModel;

namespace DocumentalManager.ViewModels
{
    public partial class FormularioViewModel : BaseViewModel
    {
        private readonly DatabaseService _databaseService;

        [ObservableProperty]
        private string tableName;

        [ObservableProperty]
        private string id; // Cambiado de int a string

        [ObservableProperty]
        private string codigo;

        [ObservableProperty]
        private string nombre;

        [ObservableProperty]
        private string observacion;

        [ObservableProperty]
        private ObservableCollection<object> itemsPadre;

        [ObservableProperty]
        private object selectedItemPadre;

        [ObservableProperty]
        private int ag;

        [ObservableProperty]
        private int ac;

        [ObservableProperty]
        private bool p;

        [ObservableProperty]
        private bool el;

        [ObservableProperty]
        private string formatoDigital;

        [ObservableProperty]
        private bool ct;

        [ObservableProperty]
        private bool e;

        [ObservableProperty]
        private bool mt;

        [ObservableProperty]
        private bool s;

        [ObservableProperty]
        private string procedimiento;

        [ObservableProperty]
        private ObservableCollection<string> formatosDisponibles = new ObservableCollection<string>
        {
            "PDF", "XLS", "JPG", "PNG", "DOC", "MP4", "MP3", "TXT"
        };

        public FormularioViewModel(DatabaseService databaseService)
        {
            _databaseService = databaseService;
            ItemsPadre = new ObservableCollection<object>();
        }

        public async Task LoadDataAsync()
        {
            IsBusy = true;
            try
            {
                await LoadParentItems();

                if (!string.IsNullOrEmpty(Id) && Id != "new") // Cambiado de Id > 0
                {
                    await LoadExistingData();
                }
            }
            finally
            {
                IsBusy = false;
            }
        }

        private async Task LoadParentItems()
        {
            switch (TableName)
            {
                case "Subfondos":
                    var fondos = await _databaseService.GetAllAsync<Fondo>();
                    foreach (var fondo in fondos)
                        ItemsPadre.Add(fondo);
                    break;
                case "UnidadesAdministrativas":
                    var subfondos = await _databaseService.GetAllAsync<Subfondo>();
                    foreach (var subfondo in subfondos)
                        ItemsPadre.Add(subfondo);
                    break;
                case "OficinasProductoras":
                    var unidades = await _databaseService.GetAllAsync<UnidadAdministrativa>();
                    foreach (var unidad in unidades)
                        ItemsPadre.Add(unidad);
                    break;
                case "Series":
                    var oficinas = await _databaseService.GetAllAsync<OficinaProductora>();
                    foreach (var oficina in oficinas)
                        ItemsPadre.Add(oficina);
                    break;
                case "Subseries":
                    var series = await _databaseService.GetAllAsync<Serie>();
                    foreach (var serie in series)
                        ItemsPadre.Add(serie);
                    break;
                case "TiposDocumentales":
                    var subseries = await _databaseService.GetAllAsync<Subserie>();
                    foreach (var subserie in subseries)
                        ItemsPadre.Add(subserie);
                    break;
            }
        }

        private async Task LoadExistingData()
        {
            switch (TableName)
            {
                case "Fondos":
                    var fondo = await _databaseService.GetByIdAsync<Fondo>(Id);
                    if (fondo != null)
                    {
                        Codigo = fondo.Codigo;
                        Nombre = fondo.Nombre;
                        Observacion = fondo.Observacion;
                    }
                    break;
                case "Subfondos":
                    var subfondo = await _databaseService.GetByIdAsync<Subfondo>(Id);
                    if (subfondo != null)
                    {
                        Codigo = subfondo.Codigo;
                        Nombre = subfondo.Nombre;
                        Observacion = subfondo.Observacion;
                        SelectedItemPadre = ItemsPadre.FirstOrDefault(i => ((Fondo)i).Id == subfondo.FondoId);
                    }
                    break;
                case "UnidadesAdministrativas":
                    var unidad = await _databaseService.GetByIdAsync<UnidadAdministrativa>(Id);
                    if (unidad != null)
                    {
                        Codigo = unidad.Codigo;
                        Nombre = unidad.Nombre;
                        Observacion = unidad.Observacion;
                        SelectedItemPadre = ItemsPadre.FirstOrDefault(i => ((Subfondo)i).Id == unidad.SubfondoId);
                    }
                    break;
                case "OficinasProductoras":
                    var oficina = await _databaseService.GetByIdAsync<OficinaProductora>(Id);
                    if (oficina != null)
                    {
                        Codigo = oficina.Codigo;
                        Nombre = oficina.Nombre;
                        Observacion = oficina.Observacion;
                        SelectedItemPadre = ItemsPadre.FirstOrDefault(i => ((UnidadAdministrativa)i).Id == oficina.UnidadAdministrativaId);
                    }
                    break;
                case "Series":
                    var serie = await _databaseService.GetByIdAsync<Serie>(Id);
                    if (serie != null)
                    {
                        Codigo = serie.Codigo;
                        Nombre = serie.Nombre;
                        Observacion = serie.Observacion;
                        SelectedItemPadre = ItemsPadre.FirstOrDefault(i => ((OficinaProductora)i).Id == serie.OficinaProductoraId);
                    }
                    break;
                case "Subseries":
                    var subserie = await _databaseService.GetByIdAsync<Subserie>(Id);
                    if (subserie != null)
                    {
                        Codigo = subserie.Codigo;
                        Nombre = subserie.Nombre;
                        Ag = subserie.AG;
                        Ac = subserie.AC;
                        P = subserie.P;
                        El = subserie.EL;
                        FormatoDigital = subserie.FormatoDigital;
                        Ct = subserie.CT;
                        E = subserie.E;
                        Mt = subserie.MT;
                        S = subserie.S;
                        Procedimiento = subserie.Procedimiento;
                        SelectedItemPadre = ItemsPadre.FirstOrDefault(i => ((Serie)i).Id == subserie.SerieId);
                    }
                    break;
                case "TiposDocumentales":
                    var tipo = await _databaseService.GetByIdAsync<TipoDocumental>(Id);
                    if (tipo != null)
                    {
                        Codigo = tipo.Codigo;
                        Nombre = tipo.Nombre;
                        Observacion = tipo.Observacion;
                        SelectedItemPadre = ItemsPadre.FirstOrDefault(i => ((Subserie)i).Id == tipo.SubserieId);
                    }
                    break;
            }
        }

        [RelayCommand]
        private async Task Guardar()
        {
            try
            {
                if (string.IsNullOrWhiteSpace(Codigo) || string.IsNullOrWhiteSpace(Nombre))
                {
                    await Application.Current.MainPage.DisplayAlert("Error", "Código y Nombre son requeridos", "OK");
                    return;
                }

                if (string.IsNullOrEmpty(Id) || Id == "new") // Cambiado de Id == 0
                    await InsertarNuevo();
                else
                    await ActualizarExistente();

                await Shell.Current.GoToAsync("..");
            }
            catch (Exception ex)
            {
                await Application.Current.MainPage.DisplayAlert("Error", ex.Message, "OK");
            }
        }

        private async Task InsertarNuevo()
        {
            switch (TableName)
            {
                case "Fondos":
                    await _databaseService.InsertAsync(new Fondo
                    {
                        Codigo = Codigo,
                        Nombre = Nombre,
                        Observacion = Observacion
                    });
                    break;
                case "Subfondos":
                    await _databaseService.InsertAsync(new Subfondo
                    {
                        Codigo = Codigo,
                        Nombre = Nombre,
                        Observacion = Observacion,
                        FondoId = SelectedItemPadre != null ? ((Fondo)SelectedItemPadre).Id : string.Empty // Cambiado de 0 a string.Empty
                    });
                    break;
                case "UnidadesAdministrativas":
                    await _databaseService.InsertAsync(new UnidadAdministrativa
                    {
                        Codigo = Codigo,
                        Nombre = Nombre,
                        Observacion = Observacion,
                        SubfondoId = SelectedItemPadre != null ? ((Subfondo)SelectedItemPadre).Id : string.Empty // Cambiado de 0 a string.Empty
                    });
                    break;
                case "OficinasProductoras":
                    await _databaseService.InsertAsync(new OficinaProductora
                    {
                        Codigo = Codigo,
                        Nombre = Nombre,
                        Observacion = Observacion,
                        UnidadAdministrativaId = SelectedItemPadre != null ? ((UnidadAdministrativa)SelectedItemPadre).Id : string.Empty // Cambiado de 0 a string.Empty
                    });
                    break;
                case "Series":
                    await _databaseService.InsertAsync(new Serie
                    {
                        Codigo = Codigo,
                        Nombre = Nombre,
                        Observacion = Observacion,
                        OficinaProductoraId = SelectedItemPadre != null ? ((OficinaProductora)SelectedItemPadre).Id : string.Empty // Cambiado de 0 a string.Empty
                    });
                    break;
                case "Subseries":
                    await _databaseService.InsertAsync(new Subserie
                    {
                        Codigo = Codigo,
                        Nombre = Nombre,
                        SerieId = SelectedItemPadre != null ? ((Serie)SelectedItemPadre).Id : string.Empty, // Cambiado de 0 a string.Empty
                        AG = ag,
                        AC = ac,
                        P = P,
                        EL = el,
                        FormatoDigital = FormatoDigital,
                        CT = ct,
                        E = E,
                        MT = mt,
                        S = S,
                        Procedimiento = Procedimiento
                    });
                    break;
                case "TiposDocumentales":
                    await _databaseService.InsertAsync(new TipoDocumental
                    {
                        Codigo = Codigo,
                        Nombre = Nombre,
                        Observacion = Observacion,
                        SubserieId = SelectedItemPadre != null ? ((Subserie)SelectedItemPadre).Id : string.Empty // Cambiado de 0 a string.Empty
                    });
                    break;
            }
        }

        private async Task ActualizarExistente()
        {
            switch (TableName)
            {
                case "Fondos":
                    var fondo = await _databaseService.GetByIdAsync<Fondo>(Id);
                    if (fondo != null)
                    {
                        fondo.Codigo = Codigo;
                        fondo.Nombre = Nombre;
                        fondo.Observacion = Observacion;
                        await _databaseService.UpdateAsync(fondo);
                    }
                    break;
                case "Subfondos":
                    var subfondo = await _databaseService.GetByIdAsync<Subfondo>(Id);
                    if (subfondo != null)
                    {
                        subfondo.Codigo = Codigo;
                        subfondo.Nombre = Nombre;
                        subfondo.Observacion = Observacion;
                        subfondo.FondoId = SelectedItemPadre != null ? ((Fondo)SelectedItemPadre).Id : string.Empty; // Cambiado de 0 a string.Empty
                        await _databaseService.UpdateAsync(subfondo);
                    }
                    break;
                case "UnidadesAdministrativas":
                    var unidad = await _databaseService.GetByIdAsync<UnidadAdministrativa>(Id);
                    if (unidad != null)
                    {
                        unidad.Codigo = Codigo;
                        unidad.Nombre = Nombre;
                        unidad.Observacion = Observacion;
                        unidad.SubfondoId = SelectedItemPadre != null ? ((Subfondo)SelectedItemPadre).Id : string.Empty; // Cambiado de 0 a string.Empty
                        await _databaseService.UpdateAsync(unidad);
                    }
                    break;
                case "OficinasProductoras":
                    var oficina = await _databaseService.GetByIdAsync<OficinaProductora>(Id);
                    if (oficina != null)
                    {
                        oficina.Codigo = Codigo;
                        oficina.Nombre = Nombre;
                        oficina.Observacion = Observacion;
                        oficina.UnidadAdministrativaId = SelectedItemPadre != null ? ((UnidadAdministrativa)SelectedItemPadre).Id : string.Empty; // Cambiado de 0 a string.Empty
                        await _databaseService.UpdateAsync(oficina);
                    }
                    break;
                case "Series":
                    var serie = await _databaseService.GetByIdAsync<Serie>(Id);
                    if (serie != null)
                    {
                        serie.Codigo = Codigo;
                        serie.Nombre = Nombre;
                        serie.Observacion = Observacion;
                        serie.OficinaProductoraId = SelectedItemPadre != null ? ((OficinaProductora)SelectedItemPadre).Id : string.Empty; // Cambiado de 0 a string.Empty
                        await _databaseService.UpdateAsync(serie);
                    }
                    break;
                case "Subseries":
                    var subserie = await _databaseService.GetByIdAsync<Subserie>(Id);
                    if (subserie != null)
                    {
                        subserie.Codigo = Codigo;
                        subserie.Nombre = Nombre;
                        subserie.SerieId = SelectedItemPadre != null ? ((Serie)SelectedItemPadre).Id : string.Empty; // Cambiado de 0 a string.Empty
                        subserie.AG = ag;
                        subserie.AC = ac;
                        subserie.P = P;
                        subserie.EL = el;
                        subserie.FormatoDigital = FormatoDigital;
                        subserie.CT = ct;
                        subserie.E = E;
                        subserie.MT = mt;
                        subserie.S = S;
                        subserie.Procedimiento = Procedimiento;
                        await _databaseService.UpdateAsync(subserie);
                    }
                    break;
                case "TiposDocumentales":
                    var tipo = await _databaseService.GetByIdAsync<TipoDocumental>(Id);
                    if (tipo != null)
                    {
                        tipo.Codigo = Codigo;
                        tipo.Nombre = Nombre;
                        tipo.Observacion = Observacion;
                        tipo.SubserieId = SelectedItemPadre != null ? ((Subserie)SelectedItemPadre).Id : string.Empty; // Cambiado de 0 a string.Empty
                        await _databaseService.UpdateAsync(tipo);
                    }
                    break;
            }
        }
    }
}

// ==================================================
// Nombre del archivo: C:\Users\asbee\source\repos\sahmael636\DocumentalManager\ViewModels\ListaViewModel.cs
// ==================================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using DocumentalManager.Models;
using DocumentalManager.Services;
using System.Collections.ObjectModel;
using System.Windows.Input;
using System.Threading.Tasks;
using System;
using System.Collections.Generic;
using System.Linq;
using System.IO;

namespace DocumentalManager.ViewModels
{
    public partial class ListaViewModel : BaseViewModel
    {
        private readonly DatabaseService _databaseService;
        private readonly ExcelService _excelService;

        [ObservableProperty]
        private string tableName;

        [ObservableProperty]
        private ObservableCollection<object> items;

        [ObservableProperty]
        private string searchText;

        [ObservableProperty]
        private ObservableCollection<object> filteredItems;

        public ListaViewModel(DatabaseService databaseService, ExcelService excelService)
        {
            _databaseService = databaseService;
            _excelService = excelService;
            Items = new ObservableCollection<object>();
            FilteredItems = new ObservableCollection<object>();
        }

        public async Task LoadDataAsync()
        {
            IsBusy = true;
            try
            {
                Items.Clear();
                var items = await GetItemsFromTable();
                foreach (var item in items)
                {
                    Items.Add(item);
                }
                FilterItems();
            }
            finally
            {
                IsBusy = false;
            }
        }

        private async Task<IEnumerable<object>> GetItemsFromTable()
        {
            switch (TableName)
            {
                case "Fondos":
                    return await _databaseService.GetAllAsync<Fondo>();
                case "Subfondos":
                    return await _databaseService.GetAllAsync<Subfondo>();
                case "UnidadesAdministrativas":
                    return await _databaseService.GetAllAsync<UnidadAdministrativa>();
                case "OficinasProductoras":
                    return await _databaseService.GetAllAsync<OficinaProductora>();
                case "Series":
                    return await _databaseService.GetAllAsync<Serie>();
                case "Subseries":
                    return await _databaseService.GetAllAsync<Subserie>();
                case "TiposDocumentales":
                    return await _databaseService.GetAllAsync<TipoDocumental>();
                default:
                    return new List<object>();
            }
        }

        [RelayCommand]
        private void FilterItems()
        {
            FilteredItems.Clear();

            if (string.IsNullOrWhiteSpace(SearchText))
            {
                foreach (var item in Items)
                {
                    FilteredItems.Add(item);
                }
            }
            else
            {
                var filtered = Items.Where(item =>
                {
                    var nombre = item.GetType().GetProperty("Nombre")?.GetValue(item)?.ToString() ?? "";
                    var codigo = item.GetType().GetProperty("Codigo")?.GetValue(item)?.ToString() ?? "";

                    return nombre.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                           codigo.Contains(SearchText, StringComparison.OrdinalIgnoreCase);
                });

                foreach (var item in filtered)
                {
                    FilteredItems.Add(item);
                }
            }
        }

        [RelayCommand]
        private async Task Nuevo()
        {
            // Navegar para creación: pasar id vacío (o "new") — ajusta FormularioViewModel para aceptar string id
            await Shell.Current.GoToAsync($"FormularioPage?tableName={TableName}&id=new");
        }

        [RelayCommand]
        private async Task Editar(object item)
        {
            // Id ahora es string (GUID)
            var id = item.GetType().GetProperty("Id")?.GetValue(item)?.ToString() ?? string.Empty;
            await Shell.Current.GoToAsync($"FormularioPage?tableName={TableName}&id={id}");
        }

        [RelayCommand]
        private async Task Eliminar(object item)
        {
            // Id ahora es string (GUID)
            var id = item.GetType().GetProperty("Id")?.GetValue(item)?.ToString() ?? string.Empty;

            // Verificar si tiene registros relacionados (firma espera string)
            var entityName = EntityNameMap[TableName];
            //var hasRelated = await _databaseService.HasRelatedRecordsAsync(TableName.TrimEnd('s'), id);
            var hasRelated = await _databaseService.HasRelatedRecordsAsync(entityName, id);

            if (hasRelated)
            {
                var confirmCascade = await Application.Current.MainPage.DisplayAlert(
                    "Advertencia",
                    "Este registro tiene subniveles relacionados. ¿Desea eliminarlo en cascada (se borrarán los registros relacionados)?",
                    "Sí, eliminar en cadena", "No");
                if (!confirmCascade) return;

                // Borrar en cascada (firma espera string)
                //await _databaseService.DeleteCascadeAsync(TableName.TrimEnd('s'), id);
                entityName = EntityNameMap[TableName];
                await _databaseService.DeleteCascadeAsync(entityName, id);
                await LoadDataAsync();
                return;
            }

            var confirm = await Application.Current.MainPage.DisplayAlert(
                "Confirmar",
                "¿Está seguro de eliminar este registro?",
                "Sí", "No");

            if (confirm)
            {
                // Borrar normal
                await DeleteItem(item);
                await LoadDataAsync();
            }
        }

        private static readonly Dictionary<string, string> EntityNameMap = new()
        {
            ["Fondos"] = "Fondo",
            ["Subfondos"] = "Subfondo",
            ["UnidadesAdministrativas"] = "UnidadAdministrativa",
            ["OficinasProductoras"] = "OficinaProductora",
            ["Series"] = "Serie",
            ["Subseries"] = "Subserie",
            ["TiposDocumentales"] = "TipoDocumental",
        };

        private async Task DeleteItem(object item)
        {
            switch (TableName)
            {
                case "Fondos":
                    await _databaseService.DeleteAsync((Fondo)item);
                    break;
                case "Subfondos":
                    await _databaseService.DeleteAsync((Subfondo)item);
                    break;
                case "UnidadesAdministrativas":
                    await _databaseService.DeleteAsync((UnidadAdministrativa)item);
                    break;
                case "OficinasProductoras":
                    await _databaseService.DeleteAsync((OficinaProductora)item);
                    break;
                case "Series":
                    await _databaseService.DeleteAsync((Serie)item);
                    break;
                case "Subseries":
                    await _databaseService.DeleteAsync((Subserie)item);
                    break;
                case "TiposDocumentales":
                    await _databaseService.DeleteAsync((TipoDocumental)item);
                    break;
            }
        }

        [RelayCommand]
        private async Task Importar()
        {
            try
            {
                var options = new PickOptions
                {
                    PickerTitle = "Seleccione archivo Excel",
                    FileTypes = new FilePickerFileType(new Dictionary<DevicePlatform, IEnumerable<string>>
            {
                { DevicePlatform.WinUI, new[] { ".xlsx", ".xls" } },
                { DevicePlatform.Android, new[] { "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "application/vnd.ms-excel" } }
            })
                };

                var result = await FilePicker.Default.PickAsync(options);
                if (result == null) return;

                var filePath = result.FullPath;

                // Helpers locales: cambios mínimos, sin tocar servicios
                string GetVal(Dictionary<string, string> d, string k)
                    => (d.GetValueOrDefault(k) ?? string.Empty).Trim();

                string GetIdOrNew(Dictionary<string, string> d, string k)
                {
                    var v = GetVal(d, k);
                    return string.IsNullOrWhiteSpace(v) ? Guid.NewGuid().ToString() : v;
                }

                bool ParseBool(Dictionary<string, string> d, string k)
                {
                    var v = GetVal(d, k);
                    return bool.TryParse(v, out var b) && b;
                }

                int ParseInt(Dictionary<string, string> d, string k)
                {
                    var v = GetVal(d, k);
                    return int.TryParse(v, out var n) ? n : 0;
                }

                async Task<bool> ExistsByIdAsync<T>(string id) where T : class, new()
                {
                    if (string.IsNullOrWhiteSpace(id)) return false;
                    var existing = await _databaseService.GetByIdAsync<T>(id);
                    return existing != null;
                }

                // ✅ IMPORTANTE: leer SIEMPRE la hoja que coincide con la tabla actual
                var sheetName = TableName;

                switch (TableName)
                {
                    case "Fondos":
                        {
                            var headers = new[] { "Id", "Codigo", "Nombre", "Observacion" };

                            Func<Dictionary<string, string>, Fondo> crear = dict => new Fondo
                            {
                                Id = GetIdOrNew(dict, "Id"),
                                Codigo = GetVal(dict, "Codigo"),
                                Nombre = GetVal(dict, "Nombre"),
                                Observacion = GetVal(dict, "Observacion")
                            };

                            Func<Fondo, Task<bool>> existeAsync =
                                //async f => await _databaseService.ExistsByCodigoAsync<Fondo>(f.Codigo?.Trim());
                                async f => await ExistsByIdAsync<Fondo>(f.Id);

                            var res = await _excelService.ImportarDesdeExcel<Fondo>(
                                filePath, headers, crear, existeAsync, sheetName);

                            var insertados = 0;
                            for (int i = 0; i < res.Entidades.Count; i++)
                            {
                                var ent = res.Entidades[i];
                                try
                                {
                                    await _databaseService.InsertAsync(ent);
                                    insertados++;
                                }
                                catch (Exception ex)
                                {
                                    res.Errores.Add((i + 2, $"Insert error: {ex.Message}"));
                                    await Application.Current.MainPage.DisplayAlert("Error al insertar", $"Fila {i + 2}: {ex.Message}", "OK");
                                }
                            }

                            await Application.Current.MainPage.DisplayAlert("Importación",
                                $"Detectados: {res.Importados}. Insertados: {insertados}. Errores: {res.Errores.Count}", "OK");
                            await LoadDataAsync();
                            break;
                        }

                    case "Subfondos":
                        {
                            var fondosExist = (await _databaseService.GetAllAsync<Fondo>()).Any();
                            if (!fondosExist)
                            {
                                await Application.Current.MainPage.DisplayAlert("Importación",
                                    "No existen Fondos en la base de datos. Importe primero los Fondos antes de importar Subfondos.", "OK");
                                return;
                            }

                            var headers = new[] { "Id", "Codigo", "Nombre", "Observacion", "FondoId" };

                            Func<Dictionary<string, string>, Subfondo> crear = dict => new Subfondo
                            {
                                Id = GetIdOrNew(dict, "Id"),
                                Codigo = GetVal(dict, "Codigo"),
                                Nombre = GetVal(dict, "Nombre"),
                                Observacion = GetVal(dict, "Observacion"),
                                FondoId = GetVal(dict, "FondoId")
                            };

                            Func<Subfondo, Task<bool>> existeAsync =
                                //async s => await _databaseService.ExistsByCodigoAsync<Subfondo>(s.Codigo?.Trim());
                                async s => await ExistsByIdAsync<Subfondo>(s.Id);

                            var res = await _excelService.ImportarDesdeExcel<Subfondo>(
                                filePath, headers, crear, existeAsync, sheetName);

                            var fondos = await _databaseService.GetAllAsync<Fondo>();
                            var insertados = 0;

                            for (int i = 0; i < res.Entidades.Count; i++)
                            {
                                var ent = res.Entidades[i];
                                var fila = res.Filas[i];

                                var fondoId = GetVal(fila, "FondoId");
                                if (!fondos.Any(f => f.Id == fondoId))
                                {
                                    res.Errores.Add((i + 2, $"No se encontró Fondo para FondoId='{fondoId}'"));
                                    continue;
                                }

                                try
                                {
                                    await _databaseService.InsertAsync(ent);
                                    insertados++;
                                }
                                catch (Exception ex)
                                {
                                    res.Errores.Add((i + 2, $"Insert error: {ex.Message}"));
                                    await Application.Current.MainPage.DisplayAlert("Error al insertar", $"Fila {i + 2}: {ex.Message}", "OK");
                                }
                            }

                            await Application.Current.MainPage.DisplayAlert("Importación",
                                $"Detectados: {res.Importados}. Insertados: {insertados}. Errores: {res.Errores.Count}", "OK");
                            await LoadDataAsync();
                            break;
                        }

                    case "UnidadesAdministrativas":
                        {
                            var subfondosExist = (await _databaseService.GetAllAsync<Subfondo>()).Any();
                            if (!subfondosExist)
                            {
                                await Application.Current.MainPage.DisplayAlert("Importación",
                                    "No existen Subfondos en la base de datos. Importe primero los Subfondos antes de importar Unidades Administrativas.", "OK");
                                return;
                            }

                            var headers = new[] { "Id", "Codigo", "Nombre", "Observacion", "SubfondoId" };

                            Func<Dictionary<string, string>, UnidadAdministrativa> crear = dict => new UnidadAdministrativa
                            {
                                Id = GetIdOrNew(dict, "Id"),
                                Codigo = GetVal(dict, "Codigo"),
                                Nombre = GetVal(dict, "Nombre"),
                                Observacion = GetVal(dict, "Observacion"),
                                SubfondoId = GetVal(dict, "SubfondoId")
                            };

                            Func<UnidadAdministrativa, Task<bool>> existeAsync =
                                //async u => (await _databaseService.GetAllAsync<UnidadAdministrativa>()).Any(x => x.Codigo == u.Codigo);
                                async u => await ExistsByIdAsync<UnidadAdministrativa>(u.Id);

                            var res = await _excelService.ImportarDesdeExcel<UnidadAdministrativa>(
                                filePath, headers, crear, existeAsync, sheetName);

                            var subfondos = await _databaseService.GetAllAsync<Subfondo>();
                            var insertados = 0;

                            for (int i = 0; i < res.Entidades.Count; i++)
                            {
                                var ent = res.Entidades[i];
                                var fila = res.Filas[i];

                                var subfondoId = GetVal(fila, "SubfondoId");
                                if (!subfondos.Any(s => s.Id == subfondoId))
                                {
                                    res.Errores.Add((i + 2, $"No se encontró Subfondo para SubfondoId='{subfondoId}'"));
                                    continue;
                                }

                                try
                                {
                                    await _databaseService.InsertAsync(ent);
                                    insertados++;
                                }
                                catch (Exception ex)
                                {
                                    res.Errores.Add((i + 2, $"Insert error: {ex.Message}"));
                                }
                            }

                            await Application.Current.MainPage.DisplayAlert("Importación",
                                $"Detectados: {res.Importados}. Insertados: {insertados}. Errores: {res.Errores.Count}", "OK");
                            await LoadDataAsync();
                            break;
                        }

                    case "OficinasProductoras":
                        {
                            var unidadesExist = (await _databaseService.GetAllAsync<UnidadAdministrativa>()).Any();
                            if (!unidadesExist)
                            {
                                await Application.Current.MainPage.DisplayAlert("Importación",
                                    "No existen Unidades Administrativas en la base de datos. Importe primero esas antes de las Oficinas Productoras.", "OK");
                                return;
                            }

                            var headers = new[] { "Id", "Codigo", "Nombre", "Observacion", "UnidadAdministrativaId" };

                            Func<Dictionary<string, string>, OficinaProductora> crear = dict => new OficinaProductora
                            {
                                Id = GetIdOrNew(dict, "Id"),
                                Codigo = GetVal(dict, "Codigo"),
                                Nombre = GetVal(dict, "Nombre"),
                                Observacion = GetVal(dict, "Observacion"),
                                UnidadAdministrativaId = GetVal(dict, "UnidadAdministrativaId")
                            };

                            Func<OficinaProductora, Task<bool>> existeAsync =
                                //async o => (await _databaseService.GetAllAsync<OficinaProductora>()).Any(x => x.Codigo == o.Codigo);
                                async o => await ExistsByIdAsync<OficinaProductora>(o.Id);

                            var res = await _excelService.ImportarDesdeExcel<OficinaProductora>(
                                filePath, headers, crear, existeAsync, sheetName);

                            var unidades = await _databaseService.GetAllAsync<UnidadAdministrativa>();
                            var insertados = 0;

                            for (int i = 0; i < res.Entidades.Count; i++)
                            {
                                var ent = res.Entidades[i];
                                var fila = res.Filas[i];

                                var unidadId = GetVal(fila, "UnidadAdministrativaId");
                                if (!unidades.Any(u => u.Id == unidadId))
                                {
                                    res.Errores.Add((i + 2, $"No se encontró UnidadAdministrativa para UnidadAdministrativaId='{unidadId}'"));
                                    continue;
                                }

                                try
                                {
                                    await _databaseService.InsertAsync(ent);
                                    insertados++;
                                }
                                catch (Exception ex)
                                {
                                    res.Errores.Add((i + 2, $"Insert error: {ex.Message}"));
                                }
                            }

                            await Application.Current.MainPage.DisplayAlert("Importación",
                                $"Detectados: {res.Importados}. Insertados: {insertados}. Errores: {res.Errores.Count}", "OK");
                            await LoadDataAsync();
                            break;
                        }

                    case "Series":
                        {
                            var oficinasExist = (await _databaseService.GetAllAsync<OficinaProductora>()).Any();
                            if (!oficinasExist)
                            {
                                await Application.Current.MainPage.DisplayAlert("Importación",
                                    "No existen Oficinas Productoras. Importe primero las Oficinas antes de las Series.", "OK");
                                return;
                            }

                            var headers = new[] { "Id", "Codigo", "Nombre", "Observacion", "OficinaProductoraId" };

                            Func<Dictionary<string, string>, Serie> crear = dict => new Serie
                            {
                                Id = GetIdOrNew(dict, "Id"),
                                Codigo = GetVal(dict, "Codigo"),
                                Nombre = GetVal(dict, "Nombre"),
                                Observacion = GetVal(dict, "Observacion"),
                                OficinaProductoraId = GetVal(dict, "OficinaProductoraId")
                            };

                            Func<Serie, Task<bool>> existeAsync =
                                //async s => (await _databaseService.GetAllAsync<Serie>()).Any(x => x.Codigo == s.Codigo);
                                async s => await ExistsByIdAsync<Serie>(s.Id);

                            var res = await _excelService.ImportarDesdeExcel<Serie>(
                                filePath, headers, crear, existeAsync, sheetName);

                            var oficinas = await _databaseService.GetAllAsync<OficinaProductora>();
                            var insertados = 0;

                            for (int i = 0; i < res.Entidades.Count; i++)
                            {
                                var ent = res.Entidades[i];
                                var fila = res.Filas[i];

                                var oficinaId = GetVal(fila, "OficinaProductoraId");
                                if (!oficinas.Any(o => o.Id == oficinaId))
                                {
                                    res.Errores.Add((i + 2, $"No se encontró OficinaProductora para OficinaProductoraId='{oficinaId}'"));
                                    continue;
                                }

                                try
                                {
                                    await _databaseService.InsertAsync(ent);
                                    insertados++;
                                }
                                catch (Exception ex)
                                {
                                    res.Errores.Add((i + 2, $"Insert error: {ex.Message}"));
                                }
                            }

                            await Application.Current.MainPage.DisplayAlert("Importación",
                                $"Detectados: {res.Importados}. Insertados: {insertados}. Errores: {res.Errores.Count}", "OK");
                            await LoadDataAsync();
                            break;
                        }

                    case "Subseries":
                        {
                            var seriesExist = (await _databaseService.GetAllAsync<Serie>()).Any();
                            if (!seriesExist)
                            {
                                await Application.Current.MainPage.DisplayAlert("Importación",
                                    "No existen Series. Importe primero las Series antes de las Subseries.", "OK");
                                return;
                            }

                            var headers = new[]
                            {
                    "Id", "Codigo", "Nombre", "Observacion", "SerieId",
                    "AG", "AC", "P", "EL", "FormatoDigital", "CT", "E", "MT", "S", "Procedimiento"
                };

                            Func<Dictionary<string, string>, Subserie> crear = dict => new Subserie
                            {
                                Id = GetIdOrNew(dict, "Id"),
                                Codigo = GetVal(dict, "Codigo"),
                                Nombre = GetVal(dict, "Nombre"),
                                Observacion = GetVal(dict, "Observacion"),
                                SerieId = GetVal(dict, "SerieId"),

                                AG = ParseInt(dict, "AG"),
                                AC = ParseInt(dict, "AC"),
                                P = ParseBool(dict, "P"),
                                EL = ParseBool(dict, "EL"),
                                FormatoDigital = GetVal(dict, "FormatoDigital"),
                                CT = ParseBool(dict, "CT"),
                                E = ParseBool(dict, "E"),
                                MT = ParseBool(dict, "MT"),
                                S = ParseBool(dict, "S"),
                                Procedimiento = GetVal(dict, "Procedimiento")
                            };

                            Func<Subserie, Task<bool>> existeAsync =
                                //async ss => (await _databaseService.GetAllAsync<Subserie>()).Any(x => x.Codigo == ss.Codigo);
                                async ss => await ExistsByIdAsync<Subserie>(ss.Id);

                            var res = await _excelService.ImportarDesdeExcel<Subserie>(
                                filePath, headers, crear, existeAsync, sheetName);

                            var series = await _databaseService.GetAllAsync<Serie>();
                            var insertados = 0;

                            for (int i = 0; i < res.Entidades.Count; i++)
                            {
                                var ent = res.Entidades[i];
                                var fila = res.Filas[i];

                                var serieId = GetVal(fila, "SerieId");
                                if (!series.Any(s => s.Id == serieId))
                                {
                                    res.Errores.Add((i + 2, $"No se encontró Serie para SerieId='{serieId}'"));
                                    continue;
                                }

                                try
                                {
                                    await _databaseService.InsertAsync(ent);
                                    insertados++;
                                }
                                catch (Exception ex)
                                {
                                    res.Errores.Add((i + 2, $"Insert error: {ex.Message}"));
                                }
                            }

                            await Application.Current.MainPage.DisplayAlert("Importación",
                                $"Detectados: {res.Importados}. Insertados: {insertados}. Errores: {res.Errores.Count}", "OK");
                            await LoadDataAsync();
                            break;
                        }

                    case "TiposDocumentales":
                        {
                            var subseriesExist = (await _databaseService.GetAllAsync<Subserie>()).Any();
                            if (!subseriesExist)
                            {
                                await Application.Current.MainPage.DisplayAlert("Importación",
                                    "No existen Subseries. Importe primero las Subseries antes de los Tipos Documentales.", "OK");
                                return;
                            }

                            var headers = new[] { "Id", "Codigo", "Nombre", "Observacion", "SubserieId" };

                            Func<Dictionary<string, string>, TipoDocumental> crear = dict => new TipoDocumental
                            {
                                Id = GetIdOrNew(dict, "Id"),
                                Codigo = GetVal(dict, "Codigo"),
                                Nombre = GetVal(dict, "Nombre"),
                                Observacion = GetVal(dict, "Observacion"),
                                SubserieId = GetVal(dict, "SubserieId")
                            };

                            Func<TipoDocumental, Task<bool>> existeAsync =
                                //async t => (await _databaseService.GetAllAsync<TipoDocumental>()).Any(x => x.Codigo == t.Codigo);
                                async t => await ExistsByIdAsync<TipoDocumental>(t.Id);

                            var res = await _excelService.ImportarDesdeExcel<TipoDocumental>(
                                filePath, headers, crear, existeAsync, sheetName);

                            var subseries = await _databaseService.GetAllAsync<Subserie>();
                            var insertados = 0;

                            for (int i = 0; i < res.Entidades.Count; i++)
                            {
                                var ent = res.Entidades[i];
                                var fila = res.Filas[i];

                                var subserieId = GetVal(fila, "SubserieId");
                                if (!subseries.Any(s => s.Id == subserieId))
                                {
                                    res.Errores.Add((i + 2, $"No se encontró Subserie para SubserieId='{subserieId}'"));
                                    continue;
                                }

                                try
                                {
                                    await _databaseService.InsertAsync(ent);
                                    insertados++;
                                }
                                catch (Exception ex)
                                {
                                    res.Errores.Add((i + 2, $"Insert error: {ex.Message}"));
                                }
                            }

                            await Application.Current.MainPage.DisplayAlert("Importación",
                                $"Detectados: {res.Importados}. Insertados: {insertados}. Errores: {res.Errores.Count}", "OK");
                            await LoadDataAsync();
                            break;
                        }

                    default:
                        await Application.Current.MainPage.DisplayAlert("Importación", "Importación no implementada para esta tabla.", "OK");
                        break;
                }
            }
            catch (Exception ex)
            {
                await Application.Current.MainPage.DisplayAlert("Error", ex.Message, "OK");
            }
        }

        [RelayCommand]
        private async Task Exportar()
        {
            try
            {
                var filePath = Path.Combine(FileSystem.CacheDirectory, $"{TableName}_{DateTime.Now:yyyyMMddHHmmss}.xlsx");

                switch (TableName)
                {
                    case "Fondos":
                        {
                            var fondos = await _databaseService.GetAllAsync<Fondo>();

                            var confirmCascade = await Application.Current.MainPage.DisplayAlert("Exportación",
                                "¿Exportar Fondos con todos sus subniveles en un único archivo (una hoja por tabla)?", "Sí", "No");

                            if (confirmCascade)
                            {
                                var subfondos = await _databaseService.GetAllAsync<Subfondo>();
                                var unidades = await _databaseService.GetAllAsync<UnidadAdministrativa>();
                                var oficinas = await _databaseService.GetAllAsync<OficinaProductora>();
                                var series = await _databaseService.GetAllAsync<Serie>();
                                var subseries = await _databaseService.GetAllAsync<Subserie>();
                                var tipos = await _databaseService.GetAllAsync<TipoDocumental>();

                                var sheets = new Dictionary<string, (IEnumerable<object>, string[], Type)>
                            {
                                { "Fondos", (fondos.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion" }, typeof(Fondo)) },
                                { "Subfondos", (subfondos.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "FondoId" }, typeof(Subfondo)) },
                                { "UnidadesAdministrativas", (unidades.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SubfondoId" }, typeof(UnidadAdministrativa)) },
                                { "OficinasProductoras", (oficinas.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "UnidadAdministrativaId" }, typeof(OficinaProductora)) },
                                { "Series", (series.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "OficinaProductoraId" }, typeof(Serie)) },
                                { "Subseries", (subseries.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SerieId", "AG", "AC", "P", "EL", "FormatoDigital", "CT", "E", "MT", "S", "Procedimiento" }, typeof(Subserie)) },
                                { "TiposDocumentales", (tipos.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SubserieId" }, typeof(TipoDocumental)) },
                            };

                                await _excelService.ExportarMultiplesAExcel(sheets, filePath);
                            }
                            else
                            {
                                await _excelService.ExportarAExcel(fondos.ToList(), filePath, new[] { "Id", "Codigo", "Nombre", "Observacion" });
                            }

                            break;
                        }

                    case "Subfondos":
                        {
                            var subfondos = await _databaseService.GetAllAsync<Subfondo>();

                            var confirmCascade = await Application.Current.MainPage.DisplayAlert("Exportación",
                                "¿Exportar Subfondos con sus descendientes (UnidadesAdministrativas, OficinasProductoras, Series, Subseries, TiposDocumentales)?", "Sí", "No");

                            if (confirmCascade)
                            {
                                var unidades = await _databaseService.GetAllAsync<UnidadAdministrativa>();
                                var oficinas = await _databaseService.GetAllAsync<OficinaProductora>();
                                var series = await _databaseService.GetAllAsync<Serie>();
                                var subseries = await _databaseService.GetAllAsync<Subserie>();
                                var tipos = await _databaseService.GetAllAsync<TipoDocumental>();

                                var sheets = new Dictionary<string, (IEnumerable<object>, string[], Type)>
                            {
                                { "Subfondos", (subfondos.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "FondoId" }, typeof(Subfondo)) },
                                { "UnidadesAdministrativas", (unidades.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SubfondoId" }, typeof(UnidadAdministrativa)) },
                                { "OficinasProductoras", (oficinas.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "UnidadAdministrativaId" }, typeof(OficinaProductora)) },
                                { "Series", (series.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "OficinaProductoraId" }, typeof(Serie)) },
                                { "Subseries", (subseries.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SerieId", "AG", "AC", "P", "EL", "FormatoDigital", "CT", "E", "MT", "S", "Procedimiento" }, typeof(Subserie)) },
                                { "TiposDocumentales", (tipos.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SubserieId" }, typeof(TipoDocumental)) },
                            };

                                await _excelService.ExportarMultiplesAExcel(sheets, filePath);
                            }
                            else
                            {
                                await _excelService.ExportarAExcel(subfondos.ToList(), filePath, new[] { "Id", "Codigo", "Nombre", "Observacion", "FondoId" });
                            }

                            break;
                        }

                    case "UnidadesAdministrativas":
                        {
                            var unidades = await _databaseService.GetAllAsync<UnidadAdministrativa>();

                            var confirmCascade = await Application.Current.MainPage.DisplayAlert("Exportación",
                                "¿Exportar Unidades Administrativas con sus descendientes (OficinasProductoras, Series, Subseries, TiposDocumentales)?", "Sí", "No");

                            if (confirmCascade)
                            {
                                var oficinas = await _databaseService.GetAllAsync<OficinaProductora>();
                                var series = await _databaseService.GetAllAsync<Serie>();
                                var subseries = await _databaseService.GetAllAsync<Subserie>();
                                var tipos = await _databaseService.GetAllAsync<TipoDocumental>();

                                var sheets = new Dictionary<string, (IEnumerable<object>, string[], Type)>
                            {
                                { "UnidadesAdministrativas", (unidades.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SubfondoId" }, typeof(UnidadAdministrativa)) },
                                { "OficinasProductoras", (oficinas.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "UnidadAdministrativaId" }, typeof(OficinaProductora)) },
                                { "Series", (series.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "OficinaProductoraId" }, typeof(Serie)) },
                                { "Subseries", (subseries.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SerieId", "AG", "AC", "P", "EL", "FormatoDigital", "CT", "E", "MT", "S", "Procedimiento" }, typeof(Subserie)) },
                                { "TiposDocumentales", (tipos.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SubserieId" }, typeof(TipoDocumental)) },
                            };

                                await _excelService.ExportarMultiplesAExcel(sheets, filePath);
                            }
                            else
                            {
                                await _excelService.ExportarAExcel(unidades.ToList(), filePath, new[] { "Id", "Codigo", "Nombre", "Observacion", "SubfondoId" });
                            }

                            break;
                        }

                    case "OficinasProductoras":
                        {
                            var oficinas = await _databaseService.GetAllAsync<OficinaProductora>();

                            var confirmCascade = await Application.Current.MainPage.DisplayAlert("Exportación",
                                "¿Exportar Oficinas Productoras con sus descendientes (Series, Subseries, TiposDocumentales)?", "Sí", "No");

                            if (confirmCascade)
                            {
                                var series = await _databaseService.GetAllAsync<Serie>();
                                var subseries = await _databaseService.GetAllAsync<Subserie>();
                                var tipos = await _databaseService.GetAllAsync<TipoDocumental>();

                                var sheets = new Dictionary<string, (IEnumerable<object>, string[], Type)>
                            {
                                { "OficinasProductoras", (oficinas.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "UnidadAdministrativaId" }, typeof(OficinaProductora)) },
                                { "Series", (series.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "OficinaProductoraId" }, typeof(Serie)) },
                                { "Subseries", (subseries.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SerieId", "AG", "AC", "P", "EL", "FormatoDigital", "CT", "E", "MT", "S", "Procedimiento" }, typeof(Subserie)) },
                                { "TiposDocumentales", (tipos.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SubserieId" }, typeof(TipoDocumental)) },
                            };

                                await _excelService.ExportarMultiplesAExcel(sheets, filePath);
                            }
                            else
                            {
                                await _excelService.ExportarAExcel(oficinas.ToList(), filePath, new[] { "Id", "Codigo", "Nombre", "Observacion", "UnidadAdministrativaId" });
                            }

                            break;
                        }

                    case "Series":
                        {
                            var series = await _databaseService.GetAllAsync<Serie>();

                            var confirmCascade = await Application.Current.MainPage.DisplayAlert("Exportación",
                                "¿Exportar Series con sus descendientes (Subseries, Tipos Documentales)?", "Sí", "No");

                            if (confirmCascade)
                            {
                                var subseries = await _databaseService.GetAllAsync<Subserie>();
                                var tipos = await _databaseService.GetAllAsync<TipoDocumental>();

                                var sheets = new Dictionary<string, (IEnumerable<object>, string[], Type)>
                            {
                                { "Series", (series.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "OficinaProductoraId" }, typeof(Serie)) },
                                { "Subseries", (subseries.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SerieId", "AG", "AC", "P", "EL", "FormatoDigital", "CT", "E", "MT", "S", "Procedimiento" }, typeof(Subserie)) },
                                { "TiposDocumentales", (tipos.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SubserieId" }, typeof(TipoDocumental)) },
                            };

                                await _excelService.ExportarMultiplesAExcel(sheets, filePath);
                            }
                            else
                            {
                                await _excelService.ExportarAExcel(series.ToList(), filePath, new[] { "Id", "Codigo", "Nombre", "Observacion", "OficinaProductoraId" });
                            }

                            break;
                        }

                    case "Subseries":
                        {
                            var subseries = await _databaseService.GetAllAsync<Subserie>();

                            var confirmCascade = await Application.Current.MainPage.DisplayAlert("Exportación",
                                "¿Exportar Subseries con sus Tipos Documentales?", "Sí", "No");

                            if (confirmCascade)
                            {
                                var tipos = await _databaseService.GetAllAsync<TipoDocumental>();

                                var sheets = new Dictionary<string, (IEnumerable<object>, string[], Type)>
                            {
                                { "Subseries", (subseries.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SerieId", "AG", "AC", "P", "EL", "FormatoDigital", "CT", "E", "MT", "S", "Procedimiento" }, typeof(Subserie)) },
                                { "TiposDocumentales", (tipos.Cast<object>(), new[] { "Id", "Codigo", "Nombre", "Observacion", "SubserieId" }, typeof(TipoDocumental)) },
                            };

                                await _excelService.ExportarMultiplesAExcel(sheets, filePath);
                            }
                            else
                            {
                                await _excelService.ExportarAExcel(subseries.ToList(), filePath, new[] { "Id", "Codigo", "Nombre", "Observacion", "SerieId", "AG", "AC", "P", "EL", "FormatoDigital", "CT", "E", "MT", "S", "Procedimiento" });
                            }

                            break;
                        }

                    case "TiposDocumentales":
                        {
                            var tipos = await _databaseService.GetAllAsync<TipoDocumental>();
                            // Tipos es el último nivel; solo exportar hoja simple
                            await _excelService.ExportarAExcel(tipos.ToList(), filePath, new[] { "Id", "Codigo", "Nombre", "Observacion", "SubserieId" });
                            break;
                        }

                    default:
                        await Application.Current.MainPage.DisplayAlert("Exportación", "Exportación no implementada para esta tabla.", "OK");
                        return;
                }

                await Application.Current.MainPage.DisplayAlert("Exportación", $"Archivo guardado en: {filePath}", "OK");
            }
            catch (Exception ex)
            {
                await Application.Current.MainPage.DisplayAlert("Error", ex.Message, "OK");
            }
        }
    }
}

